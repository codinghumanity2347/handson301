node {

    def server = Artifactory.server "01"

    def buildInfo = Artifactory.newBuildInfo() 



// Project Dir

    def project_path = "petclinic-zidi"





stage('GitCheckOut') {

git branch: 'master', credentialsId: '01', url: 'https://github.com/codinghumanity2347/handson301.git'

}

dir(project_path){



stage('Maven Clean') {

sh 'mvn clean'

}



stage('Maven Compile') {

sh 'mvn compile'

}



stage('Maven test') {

sh 'mvn test'

}



stage('Maven pkg') {

sh 'mvn package'

}



stage('Build Managment') {

      def uploadSpec = """{

	 "files": [

	{

	"pattern": "target/*.war",

	"target": "petclinic.war"

        }

	]

	}"""

	server.upload spec: uploadSpec

 }




stage('Publish build info') {

  server.publishBuildInfo buildInfo

}



stage('Archive Artifacts') {

archive 'target/*.war'    

}



stage('Deployment - PreProd') {

sh 'docker-compose up -d --build'

}

}



stage('Deployment - Stage'){

 deploy adapters: [tomcat8(credentialsId: '01', path: '', url: 'http://ucplc91343dns.eastus2.cloudapp.azure.com:8080')], contextPath: 'petclinic', onFailure: false, war: 'petclinic-zidi/target/petclinic.war'

}

 

}
